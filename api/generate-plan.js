// api/generate-plan.js
import cors from 'cors';
import express from 'express';

// æ‰‹åŠ¨å®ç° CORS + JSON è§£æï¼ˆå› ä¸ºä¸èƒ½ç”¨å®Œæ•´ Expressï¼‰
const applyCors = (req, res, fn) => {
  return new Promise((resolve) => {
    cors()(req, res, () => {
      resolve(fn());
    });
  });
};

// å¤åˆ¶ä½ çš„ generatePlan å‡½æ•°ï¼ˆåŸæ ·ä¸åŠ¨ï¼‰
function generatePlan(answers) {
  const { intro = '', goal = '', timePerDay = '', learningStyle = '', finalNote = '' } = answers;
  let output = '';

  if (intro) {
    output += `ğŸ’¬ **ä½ è¯´**ï¼šâ€œ${intro}â€\n\n`;
  }

  const fullText = (intro + ' ' + finalNote).toLowerCase();
  let planType = 'general';

  // æ³°å‹’å±•å¼€
  if (/æ³°å‹’|taylor|å±•å¼€|è¿‘ä¼¼|ä½™é¡¹|éº¦å…‹åŠ³æ—/.test(fullText)) {
    planType = 'taylor';
    output += `ğŸ” **æ ¸å¿ƒé—®é¢˜**ï¼šä½ æŠŠæ³°å‹’å½“æˆè®°å¿†å…¬å¼ï¼Œè€Œä¸æ˜¯â€œç”¨å¤šé¡¹å¼å±€éƒ¨é€¼è¿‘å‡½æ•°â€çš„æ€æƒ³ã€‚\n`;
    output += `âœ… **æœ¬å‘¨èšç„¦**ï¼šç†è§£â€œä½™é¡¹ = è¯¯å·®â€ï¼ŒæŒæ¡å‰3é˜¶å±•å¼€ã€‚\n\n`;
    
    output += `ğŸ“Œ **æ€ç»´å®éªŒ**ï¼š\n`;
    output += `1. æƒ³è±¡ä½ åœ¨å±±é¡¶ä¿¯ç°å±±è°·ï¼Œåªçœ‹å¾—æ¸…æœ€è¿‘çš„å¡åº¦ã€‚\n`;
    output += `2. ä½ ä¸çŸ¥é“æ•´ä¸ªå±±çš„å½¢çŠ¶ï¼Œä½†ä½ çŸ¥é“ï¼š\n`;
    output += `   - å±±é¡¶é«˜åº¦ f(a)\n`;
    output += `   - æ–œç‡ f'(a)\n`;
    output += `   - å¼¯æ›²ç¨‹åº¦ f''(a)\n`;
    output += `3. äºæ˜¯ä½ ç”¨â€œå¹³åœ° + å¡åº¦ + å¼¯æ›²â€æ¥è¿‘ä¼¼å±±ä½“ â†’ å°±æ˜¯æ³°å‹’å±•å¼€ï¼\n\n`;
    
    output += `ğŸ’¡ **å…³é”®ç±»æ¯”**ï¼š\n`;
    output += `- â€œç”¨ç›´çº¿æ‹Ÿåˆæ›²çº¿â€ â†’ ä¸€é˜¶å±•å¼€ï¼ˆåˆ‡çº¿ï¼‰\n`;
    output += `- â€œç”¨æŠ›ç‰©çº¿æ‹Ÿåˆæ›²çº¿â€ â†’ äºŒé˜¶å±•å¼€ï¼ˆè€ƒè™‘å¼¯æ›²ï¼‰\n\n`;
    
    output += `ğŸ› ï¸ **å®æ“å»ºè®®**ï¼š\n`;
    output += `1. é€‰å‡½æ•°ï¼šf(x) = e^xï¼Œåœ¨ a=0 å¤„å±•å¼€\n`;
    output += `2. è®¡ç®—ï¼šf(0)=1, f'(0)=1, f''(0)=1\n`;
    output += `3. å†™å‡ºï¼še^x â‰ˆ 1 + x + xÂ²/2\n`;
    output += `4. æ‰‹ç»˜ï¼šç”»å‡º e^x å’Œå®ƒçš„è¿‘ä¼¼å¤šé¡¹å¼ï¼ˆè‰ç¨¿çº¸å³å¯ï¼‰\n`;
    output += `5. è§‚å¯Ÿï¼šå½“ x=0.1 æ—¶ï¼Œè¿‘ä¼¼å€¼â‰ˆ1.105ï¼ŒçœŸå®å€¼â‰ˆ1.10517 â†’ è¯¯å·®æå°ï¼\n\n`;
    
    output += `âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š\n`;
    output += `- åªèƒŒå…¬å¼ï¼Œä¸ç†è§£â€œä¸ºä»€ä¹ˆéœ€è¦æ›´é«˜é˜¶â€\n`;
    output += `- å¿½è§†ä½™é¡¹ â†’ å®ƒå‘Šè¯‰ä½ â€œè¯¯å·® â‰¤ |x|Â³/6â€\n\n`;
    
    output += `ğŸ¯ **æœ¬å‘¨ä»»åŠ¡**ï¼š\n`;
    output += `- å¯¹ ln(1+x) åœ¨ a=0 å¤„åšäºŒé˜¶å±•å¼€\n`;
    output += `- è®¡ç®— x=0.2 æ—¶çš„çœŸå®å€¼ vs è¿‘ä¼¼å€¼\n`;
    output += `- éªŒè¯è¯¯å·®æ˜¯å¦å°äº xÂ³\n\n`;
  }
  
  // æ ¼æ—å…¬å¼æ–¹å‘
  else if (
    (/æ ¼æ—|green|æ›²çº¿ç§¯åˆ†/.test(fullText) && /æ–¹å‘|æ­£å‘|ç»•å‘|é¡ºæ—¶é’ˆ|é€†æ—¶é’ˆ|æå/.test(fullText)) ||
    (/åŒºåŸŸ.*å·¦æ‰‹|å·¦æ‰‹.*åŒºåŸŸ/.test(fullText))
  ) {
    planType = 'greens';
    output += `ğŸ” **æ ¸å¿ƒé—®é¢˜**ï¼šâ€œæ­£å‘â€ä¸æ˜¯è§„å®šï¼Œè€Œæ˜¯â€œåŒºåŸŸåœ¨å·¦æ‰‹è¾¹â€çš„è‡ªç„¶ç»“æœã€‚\n`;
    output += `âœ… **æœ¬å‘¨èšç„¦**ï¼šæŒæ¡â€œæ¹–å²¸è·‘æ­¥æ³•â€åˆ¤æ–­æ–¹å‘ + å…¬å¼é€‚ç”¨æ¡ä»¶ã€‚\n\n`;
    
    output += `ğŸ“Œ **æ€ç»´å®éªŒ**ï¼š\n`;
    output += `1. æƒ³è±¡ä½ åœ¨ä¸€æ¡æ¹–è¾¹è·‘æ­¥ã€‚\n`;
    output += `2. ä½ çš„å·¦æ‰‹æŒ‡å‘æ¹–å†… â†’ è¿™å°±æ˜¯â€œæ­£å‘â€ã€‚\n`;
    output += `3. å¦‚æœä½ ç»•ç€æ¹–è·‘ä¸€åœˆï¼Œèº«ä½“å§‹ç»ˆæœå¤–ï¼Œæ‰‹åœ¨æ¹–é‡Œ â†’ æ–¹å‘å°±å¯¹äº†ï¼\n\n`;
    
    output += `ğŸ’¡ **å£è¯€**ï¼š> â€œå·¦æ‰‹æŠ±æ¹–ï¼Œå³æ‰‹æ‹å²¸â€\n\n`;
    
    output += `ğŸ› ï¸ **å®æ“å»ºè®®**ï¼š\n`;
    output += `1. æ‹¿ä¸€å¼ çº¸ç”»ä¸€ä¸ªé—­åˆæ›²çº¿ï¼ˆæ¯”å¦‚æ¤­åœ†ï¼‰\n`;
    output += `2. åœ¨æ›²çº¿ä¸Šä»»å–ä¸€ç‚¹ï¼Œç”»å‡ºåˆ‡çº¿æ–¹å‘\n`;
    output += `3. æƒ³è±¡è‡ªå·±ç«™åœ¨é‚£ç‚¹ï¼Œæ²¿æ›²çº¿èµ°\n`;
    output += `4. é—®ï¼šâ€œæˆ‘çš„å·¦æ‰‹æ˜¯æœå‘åŒºåŸŸå†…éƒ¨å—ï¼Ÿâ€\n`;
    output += `5. å¦‚æœæ˜¯ â†’ æ­£å‘ï¼›å¦åˆ™ â†’ åå‘\n\n`;
    
    output += `âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š\n`;
    output += `- è®¤ä¸ºâ€œé€†æ—¶é’ˆå°±æ˜¯æ­£å‘â€ â†’ é”™ï¼åªæœ‰åŒºåŸŸåœ¨å·¦è¾¹æ—¶æ‰æ˜¯\n`;
    output += `- å¿½ç•¥â€œæ´â€ â†’ ç¯å½¢åŒºåŸŸï¼šå¤–åœˆæ­£å‘ï¼ˆé€†æ—¶é’ˆï¼‰ï¼Œå†…åœˆæ­£å‘ï¼ˆé¡ºæ—¶é’ˆï¼‰ï¼\n\n`;
    
    output += `ğŸ¯ **æœ¬å‘¨ä»»åŠ¡**ï¼š\n`;
    output += `- ç”»ä¸‰è§’å½¢ã€åœ†å½¢ã€å¸¦æ´åŒºåŸŸå„ä¸€ä¸ª\n`;
    output += `- ç”¨â€œæ¹–å²¸è·‘æ­¥æ³•â€æ ‡å‡ºæ­£å‘\n`;
    output += `- å†™ä¸‹åˆ¤æ–­è¿‡ç¨‹\n\n`;
  }
  
  // æåæ ‡
  else if (/æåæ ‡|polar|r,Î¸|ç§¯åˆ†é™|ç”»å›¾/.test(fullText)) {
    planType = 'polar';
    output += `ğŸ” **æ ¸å¿ƒé—®é¢˜**ï¼šç”¨ç›´è§’åæ ‡çš„â€œæ¡†â€æ€ç»´å¥—æåæ ‡çš„â€œç”Ÿé•¿â€é€»è¾‘ã€‚\n`;
    output += `âœ… **æœ¬å‘¨èšç„¦**ï¼šå…ˆå®š Î¸ èŒƒå›´ï¼Œå†å®š r ä¸Šä¸‹é™ã€‚\n\n`;
    
    output += `ğŸ“Œ **æ€ç»´å®éªŒ**ï¼š\n`;
    output += `1. æƒ³è±¡é›·è¾¾æ‰«æï¼šä» Î¸=0 å¼€å§‹ï¼Œæ…¢æ…¢æ—‹è½¬åˆ° Î¸=Ï€\n`;
    output += `2. åœ¨æ¯ä¸ªè§’åº¦ Î¸ï¼Œr ä» 0 ç”Ÿé•¿åˆ°è¾¹ç•Œ\n`;
    output += `3. è¾¹ç•Œå¯èƒ½æ˜¯ï¼šr = sinÎ¸ï¼ˆå¿ƒå½¢çº¿ï¼‰ã€r = 1ï¼ˆåœ†ï¼‰ç­‰\n\n`;
    
    output += `ğŸ› ï¸ **å®æ“å»ºè®®**ï¼š\n`;
    output += `1. ç”»åŒºåŸŸï¼šr â‰¤ 1 + cosÎ¸ï¼ˆå¿ƒå½¢çº¿ï¼‰\n`;
    output += `2. é—®ï¼šÎ¸ ä»å¤šå°‘åˆ°å¤šå°‘ï¼Ÿâ†’ 0 åˆ° 2Ï€\n`;
    output += `3. é—®ï¼šå¯¹æ¯ä¸ª Î¸ï¼Œr ä»å“ªåˆ°å“ªï¼Ÿâ†’ 0 åˆ° 1+cosÎ¸\n`;
    output += `4. å†™å‡ºç§¯åˆ†é™ï¼šâˆ«â‚€Â²Ï€ âˆ«â‚€Â¹âºá¶œáµ’Ë¢á¶¿ ...\n\n`;
    
    output += `âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š\n`;
    output += `- å…ˆå®š r å†å®š Î¸ â†’ é¡ºåºåäº†ï¼\n`;
    output += `- å¿˜è®° r â‰¥ 0 â†’ å½“ 1+cosÎ¸ < 0 æ—¶ï¼Œå®é™… r=0\n\n`;
    
    output += `ğŸ¯ **æœ¬å‘¨ä»»åŠ¡**ï¼š\n`;
    output += `- ç»ƒä¹ ï¼šr â‰¤ 2sinÎ¸ï¼ˆä¸ŠåŠåœ†ï¼‰\n`;
    output += `- å†™å‡º Î¸ å’Œ r çš„èŒƒå›´\n`;
    output += `- è®¡ç®—é¢ç§¯ âˆ«âˆ« r dr dÎ¸\n\n`;
  }
  
  // éšå‡½æ•°æ±‚å¯¼
  else if (/éšå‡½æ•°|implicit|F\(x,y\)|dy\/dx/.test(fullText)) {
    planType = 'implicit';
    output += `ğŸ” **æ ¸å¿ƒé—®é¢˜**ï¼šä¸æ•¢å¯¹ F(x,y)=0 ä¸¤è¾¹æ±‚å¯¼ï¼Œæ˜¯å› ä¸ºæ²¡çœ‹åˆ°â€œç­‰é«˜çº¿â€å›¾åƒã€‚\n`;
    output += `âœ… **æœ¬å‘¨èšç„¦**ï¼šæŒæ¡ dy/dx = -Fâ‚“/Fáµ§ çš„å‡ ä½•æ„ä¹‰ã€‚\n\n`;
    
    output += `ğŸ“Œ **æ€ç»´å®éªŒ**ï¼š\n`;
    output += `1. æƒ³è±¡åœ°å½¢å›¾ï¼šF(x,y)=c æ˜¯ç­‰é«˜çº¿\n`;
    output += `2. æ²¿ç­‰é«˜çº¿èµ°ï¼Œé«˜åº¦ä¸å˜ â†’ dF = 0\n`;
    output += `3. æ‰€ä»¥ Fâ‚“ dx + Fáµ§ dy = 0 â†’ dy/dx = -Fâ‚“/Fáµ§\n\n`;
    
    output += `ğŸ› ï¸ **å®æ“å»ºè®®**ï¼š\n`;
    output += `1. ç»™å®šï¼šxÂ² + yÂ² = 1\n`;
    output += `2. è®¾ F(x,y) = xÂ² + yÂ² - 1\n`;
    output += `3. è®¡ç®—ï¼šFâ‚“ = 2x, Fáµ§ = 2y\n`;
    output += `4. æ‰€ä»¥ï¼šdy/dx = -2x/(2y) = -x/y\n`;
    output += `5. éªŒè¯ï¼šåœ¨ (0,1) ç‚¹ï¼Œæ–œç‡ä¸º 0 â†’ æ°´å¹³åˆ‡çº¿ï¼Œåˆç†ï¼\n\n`;
    
    output += `âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š\n`;
    output += `- ç›´æ¥å¯¹ y æ±‚å¯¼å¿˜è®°é“¾å¼æ³•åˆ™\n`;
    output += `- ä¸ç†è§£ Fáµ§ â‰  0 çš„æ¡ä»¶ï¼ˆåˆ†æ¯ä¸èƒ½ä¸ºé›¶ï¼‰\n\n`;
    
    output += `ğŸ¯ **æœ¬å‘¨ä»»åŠ¡**ï¼š\n`;
    output += `- å¯¹ yÂ³ + xy = 1 æ±‚ dy/dx\n`;
    output += `- åœ¨ç‚¹ (0,1) è®¡ç®—åˆ‡çº¿æ–œç‡\n\n`;
  }
  
  // é‡ç§¯åˆ†åŒºåŸŸ
  else if (/é‡ç§¯åˆ†|äºŒé‡|ä¸‰é‡|ç§¯åˆ†åŒºåŸŸ|ç”»ä¸å‡º/.test(fullText)) {
    planType = 'multiple';
    output += `ğŸ” **æ ¸å¿ƒé—®é¢˜**ï¼šè¯•å›¾è„‘è¡¥3DåŒºåŸŸï¼Œè€Œä¸æ˜¯â€œåˆ‡ç‰‡â†’æŠ•å½±â€é™ç»´ã€‚\n`;
    output += `âœ… **æœ¬å‘¨èšç„¦**ï¼šå­¦ä¼šç”» xy æŠ•å½± + ç¡®å®š z ä¸Šä¸‹é™ã€‚\n\n`;
    
    output += `ğŸ“Œ **æ€ç»´å®éªŒ**ï¼š\n`;
    output += `1. æƒ³è±¡åˆ‡é¢åŒ…ï¼šæŠŠ3DåŒºåŸŸåˆ‡æˆè–„ç‰‡ï¼ˆå›ºå®š zï¼‰\n`;
    output += `2. æ¯ä¸€ç‰‡åœ¨ xy å¹³é¢çš„å½±å­ â†’ æŠ•å½±åŒºåŸŸ D\n`;
    output += `3. å¯¹æ¯ä¸ª (x,y) âˆˆ Dï¼Œz ä»ä¸‹è¡¨é¢åˆ°ä¸Šè¡¨é¢\n\n`;
    
    output += `ğŸ› ï¸ **å®æ“å»ºè®®**ï¼š\n`;
    output += `1. åŒºåŸŸï¼šz = 1 - xÂ² - yÂ² ä¸ z = 0 ä¹‹é—´\n`;
    output += `2. æŠ•å½±ï¼šä»¤ z=0 â†’ xÂ² + yÂ² â‰¤ 1ï¼ˆå•ä½åœ†ï¼‰\n`;
    output += `3. å¯¹æ¯ä¸ª (x,y) âˆˆ å•ä½åœ†ï¼Œz ä» 0 åˆ° 1-xÂ²-yÂ²\n`;
    output += `4. å†™å‡ºï¼šâˆ«âˆ«_D [âˆ«â‚€^{1-xÂ²-yÂ²} dz] dxdy\n\n`;
    
    output += `âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š\n`;
    output += `- ç›´æ¥å†™ âˆ«âˆ«âˆ« ... è€Œä¸ç”»æŠ•å½±\n`;
    output += `- æ··æ·† z çš„ä¸Šä¸‹é™ï¼ˆè°åœ¨ä¸Šï¼Ÿè°åœ¨ä¸‹ï¼Ÿï¼‰\n\n`;
    
    output += `ğŸ¯ **æœ¬å‘¨ä»»åŠ¡**ï¼š\n`;
    output += `- åŒºåŸŸï¼šz = xÂ² + yÂ² ä¸ z = 4 ä¹‹é—´\n`;
    output += `- ç”»å‡º xy æŠ•å½±\n`;
    output += `- å†™å‡ºä¸‰é‡ç§¯åˆ†è¡¨è¾¾å¼\n\n`;
  }
  
  // é€šç”¨å»ºè®®
  else {
    output += `ğŸ§  **ä½ èƒ½è¯´å‡ºå›°æƒ‘ï¼Œè¿™å·²ç»æ˜¯çªç ´çš„ç¬¬ä¸€æ­¥ã€‚**\n`;
    output += `âœ… **å»ºè®®**ï¼šä»ä¸€é“é”™é¢˜å¼€å§‹ï¼Œå†™ä¸‹â€œæˆ‘ä¸æ‡‚ä¸ºä»€ä¹ˆè¿™é‡Œè¦______â€ã€‚\n\n`;
  }

  // æ—¶é—´ & ç›®æ ‡é€‚é…
  let dailyMin = 30;
  if (/å°‘|<30|çŸ­|æ²¡æ—¶é—´/.test(timePerDay)) dailyMin = 15;
  else if (/1~2å°æ—¶|60|ä»¥ä¸Š/.test(timePerDay)) dailyMin = 60;

  let target = 'æœŸæœ«è¿‡å…³';
  if (/è€ƒç ”/i.test(goal)) target = 'è€ƒç ”æ•°å­¦';
  else if (/ç†è§£|çœŸæ­£/.test(goal)) target = 'æ·±åº¦ç†è§£';

  output += `## ğŸ“… ä½ çš„ä¸“å±ã€${target}ã€‘7å¤©å¯åŠ¨è®¡åˆ’\n\n`;

  output += `### ğŸŒŸ æ¯æ—¥å¿…åšï¼ˆä»…éœ€ ${dailyMin} åˆ†é’Ÿï¼‰\n`;
  output += `- **ç¬¬1æ­¥**ï¼šå®Œæˆä¸Šé¢çš„â€œæœ¬å‘¨ä»»åŠ¡â€ä¸­çš„ä¸€å°éƒ¨åˆ†\n`;
  output += `- **ç¬¬2æ­¥**ï¼šæ‰‹å†™æ¨å¯¼æ ¸å¿ƒå…¬å¼ï¼ˆå“ªæ€•æŠ„ä¸€éï¼‰\n`;
  if (dailyMin >= 30) {
    output += `- **ç¬¬3æ­¥**ï¼šåš 1 é“å…¸å‹ä¾‹é¢˜ï¼ˆæ¨èï¼šåŒæµé«˜æ•°ï¼‰\n`;
  }
  output += `\n`;

  // 7å¤©è®¡åˆ’ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const weekPlans = {
    taylor: [
      "Day1: ç†è§£ f(x) â‰ˆ f(a) + fâ€™(a)(x-a)",
      "Day2: åŠ¨æ‰‹å±•å¼€ e^x åˆ°äºŒé˜¶",
      "Day3: æ¨å¯¼ä½™é¡¹ Râ‚‚(x)",
      "Day4: åš1é“è¿‘ä¼¼è®¡ç®—é¢˜",
      "Day5: å¯¹æ¯”ä¸åŒå±•å¼€ç‚¹æ•ˆæœ",
      "Day6: æ•´ç†å¸¸è§å‡½æ•°å±•å¼€è¡¨",
      "Day7: æ¨¡æ‹Ÿè€ƒï¼š10åˆ†é’Ÿå®Œæˆ1é“ç»¼åˆé¢˜"
    ],
    greens: [
      "Day1: ç†è§£â€œå·¦æ‰‹æŠ±æ¹–â€",
      "Day2: ç”»3ä¸ªåŒºåŸŸæ ‡æ­£å‘",
      "Day3: æ¨å¯¼æ ¼æ—å…¬å¼æ¡ä»¶",
      "Day4: åš1é“æ–¹å‘åˆ¤æ–­é¢˜",
      "Day5: ç»ƒä¹ æ›²çº¿ç§¯åˆ†è½¬äºŒé‡ç§¯åˆ†",
      "Day6: æ€»ç»“ï¼šä»€ä¹ˆæƒ…å†µä¸èƒ½ç”¨ï¼Ÿ",
      "Day7: æ¨¡æ‹Ÿè€ƒï¼šè®¡ç®— âˆ®_C ..."
    ],
    polar: [
      "Day1: ç”» r=sin(2Î¸), r=1+cosÎ¸",
      "Day2: ç»ƒä¹ å†™ Î¸ å’Œ r èŒƒå›´",
      "Day3: è®¡ç®—1ä¸ªæåæ ‡ç§¯åˆ†",
      "Day4: å¯¹æ¯”ç›´è§’åæ ‡æ•ˆç‡",
      "Day5: å¤„ç†å¤æ‚åŒºåŸŸ",
      "Day6: æ•´ç†æ¨¡æ¿",
      "Day7: æ¨¡æ‹Ÿè€ƒï¼šè®¡ç®—èŠ±ç“£é¢ç§¯"
    ],
    implicit: [
      "Day1: ç†è§£ F(x,y)=c æ˜¯ç­‰é«˜çº¿",
      "Day2: æ¨å¯¼ dy/dx = -Fâ‚“/Fáµ§",
      "Day3: è®¡ç®—1ä¸ªéšå‡½æ•°å¯¼æ•°",
      "Day4: ç†è§£å‡ ä½•æ„ä¹‰",
      "Day5: ç»ƒä¹ é«˜é˜¶æ±‚å¯¼",
      "Day6: æ±‚åˆ‡çº¿æ–¹ç¨‹",
      "Day7: æ¨¡æ‹Ÿè€ƒï¼šç»™å®š F(x,y,z)=0..."
    ],
    multiple: [
      "Day1: ç†è§£â€œåˆ‡ç‰‡â†’æŠ•å½±â€",
      "Day2: ç”»1ä¸ª3DåŒºåŸŸçš„æŠ•å½±",
      "Day3: å†™å‡º1ä¸ªä¸‰é‡ç§¯åˆ†",
      "Day4: ç»ƒä¹ äº¤æ¢ç§¯åˆ†æ¬¡åº",
      "Day5: å­¦æŸ±åæ ‡è½¬æ¢",
      "Day6: ç»ƒçƒåæ ‡",
      "Day7: æ¨¡æ‹Ÿè€ƒï¼šè®¡ç®—ä½“ç§¯"
    ]
  };

  const plan = weekPlans[planType] || [
    "Day1: æ‰¾1é“é”™é¢˜ï¼Œå†™ä¸‹å¡ç‚¹",
    "Day2: çœ‹ä¸€ä¸ªæ¦‚å¿µè§£é‡Šï¼ˆå¦‚Bç«™ï¼‰",
    "Day3: æ‰‹å†™æ•´ç†å…¬å¼+æ¡ä»¶",
    "Day4: åš3é“åŸºç¡€é¢˜",
    "Day5: å°è¯•è®²è§£ç»™åˆ«äººå¬",
    "Day6: åš1é“ç»¼åˆé¢˜",
    "Day7: å¤ç›˜ï¼šå“ªäº›åœ°æ–¹ä¸å†å¡äº†ï¼Ÿ"
  ];

  plan.forEach((item, i) => {
    output += `- **${item}**\n`;
  });
  output += `\n`;

  // å·¥å…·ç®±
  output += `## ğŸ§° ä½ çš„å·¥å…·ç®±\n`;
  output += `- ğŸ“š **æ•™æé‡ç‚¹**ï¼šåŒæµã€Šé«˜ç­‰æ•°å­¦ã€‹ç¬¬7ç‰ˆ\n`;
  output += `- ğŸ¥ **Bç«™ç²¾é€‰**ï¼š[3Blue1Brown å¾®ç§¯åˆ†æœ¬è´¨](https://www.bilibili.com/video/BV1CAxaeHEeH?spm_id_from=333.788.videopod.episodes&vd_source=cbfd42c5d90f2e0917e8f72b9d3806f4&p=40)\n`;
  output += `- âœï¸ **å¿…å¤‡åŠ¨ä½œ**ï¼šæ‰‹å†™ï¼æ‰‹å†™ï¼æ‰‹å†™ï¼\n\n`;

  // æƒ…ç»ªæ”¯æŒ
  if (/æ€¥|ç„¦è™‘|æ…Œ|å´©æºƒ|æ”¾å¼ƒ|è®¨åŒ/.test(finalNote)) {
    output += `ğŸ’Œ **ä½ è¯´**ï¼šâ€œ${finalNote}â€â€”â€”æˆ‘æ‡‚ã€‚\n`;
    output += `âœ¨ **ä½†è¯·ç›¸ä¿¡ï¼šé«˜æ•°ä¸æ˜¯å¤©èµ‹æ¸¸æˆï¼Œè€Œæ˜¯è§†è§’æ¸¸æˆã€‚**\n`;
    output += `âœ… **ä½ ä¸éœ€è¦ä¸€æ¬¡å…¨æ‡‚ï¼Œåªéœ€è¦æ¯å¤©æ¨è¿›1%ã€‚**\n\n`;
  }

  output += `ğŸš€ **è¿™ä»½è®¡åˆ’çš„ä»·å€¼ï¼Œä¸åœ¨â€œå®Œç¾â€ï¼Œè€Œåœ¨â€œä½ ä»Šå¤©å°±å¼€å§‹äº†â€ã€‚**\n`;
  output += `ğŸ’¡ **ç°åœ¨ï¼Œæ·±å‘¼å¸ï¼Œæ‹¿å‡ºè‰ç¨¿çº¸ï¼Œå†™ä¸‹ç¬¬ä¸€ä¸ªå…¬å¼â€”â€”ä½ å·²ç»èµ¢äº†ã€‚**`;

  return output;
}

// Vercel Serverless å‡½æ•°å…¥å£
export default async (req, res) => {
  // æ‰‹åŠ¨è§£æ JSON
  let body = {};
  try {
    body = JSON.parse(req.body);
  } catch (e) {
    return res.status(400).json({ error: 'Invalid JSON' });
  }

  const { answers } = body;
  if (!answers || (!answers.intro && !answers.finalNote)) {
    return res.status(400).json({ error: 'è¯·è‡³å°‘æè¿°ä¸€ç‚¹ä½ çš„å›°æƒ‘ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„èµ·ç‚¹ â¤ï¸' });
  }

  const plan = generatePlan(answers);

  // è®¾ç½® CORS å¤´
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  return res.status(200).json({ plan });
};
